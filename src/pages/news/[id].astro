---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { API_NETWORK } from "../../constants";
const { id } = Astro.params;

const token = Astro.cookies.get("authToken")?.value;
console.log("Token:", token);

if (!token) {
  return Astro.redirect("/");
}

const response = await fetch(`${API_NETWORK}news/${id}`, {
  headers: {
    Authorization: `Bearer ${token}`,
    "Content-Type": "application/json",
  },
});

const data = await response.json();
const newsDetail = data.news[0];

console.log("News detail:", newsDetail);
---

<Layout title={newsDetail?.title}>
  <section class="container-profile">
    <button class="delete" id="deleteBtn">Delete</button>
    <img
      src={newsDetail?.picture_url}
      class="news-image"
      alt={newsDetail?.title}
    />
    <div class="container-title">
      <h1>{newsDetail?.title}</h1>
      <h3>{newsDetail?.subtitle}</h3>
    </div>
    <div class="container-profileData">
      <img
        src={newsDetail?.picture}
        alt={newsDetail?.username}
        class="author-picture"
      />
      <h3 class="title-username">
        {newsDetail?.username}
        <span class="typeOfJournalist">- {newsDetail?.type_of_journalist}</span>
      </h3>
      <span class="published">
        | Published on {
          new Date(newsDetail?.created_at).toLocaleDateString()
        }</span
      >
    </div>
    <section class="container-content">
      <p>{newsDetail?.body}</p>
    </section>
  </section>
</Layout>
<script is:inline define:vars={{ id, token, apiUrl: API_NETWORK }}>
  console.log("üîë Token que se est√° enviando:", token);
  console.log("üìç URL del fetch:", `${apiUrl}news/${id}`);

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this news?")) {
        return;
      }

      try {
        console.log("üöÄ Enviando DELETE con token:", token);

        const response = await fetch(`${apiUrl}news/${id}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          credentials: "include",
        });

        console.log("üì• Response status:", response.status);

        if (response.ok) {
          alert("News deleted successfully");
          window.location.href = "/dashboard";
        } else {
          const errorText = await response.text();
          console.log("‚ùå Backend error:", errorText);
          alert(`Failed to delete news: ${errorText}`);
        }
      } catch (error) {
        console.error("üí• Error deleting news:", error);
        alert("An error occurred while deleting the news");
      }
    });
  });
</script>

<style>
  .container-profile {
    max-width: 800px;
    margin: 0 auto;
  }
  .news-image {
    width: 100%;
    height: 50vh;
    border-radius: 28px;
    margin-bottom: 1rem;
    object-fit: cover;
    aspect-ratio: 16/9;
  }
  .container-title h1 {
    font-size: 2em;
    padding: 0;
    margin: 0;
  }

  .container-profile div {
    margin-top: 10px;
    font-size: 0.9em;
  }
  .container-title > h3 {
    font-weight: 500;
    font-size: 1.25em;
    padding: 0;
    margin: 0;
    opacity: 0.8;
  }
  .container-title {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .container-profileData {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .author-picture {
    width: 4em;
    height: 4em;
    border-radius: 50%;
    object-fit: cover;
    aspect-ratio: 1/1;
  }
  .title-username {
    font-size: 1.2em;
    margin: 0;
    padding: 0;
    align-items: center;
  }
  .typeOfJournalist,
  .published {
    font-weight: 400;
    opacity: 0.7;
    font-size: 0.8em;
  }
  .delete {
    background-color: #ff4d4d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 1rem;
    position: fixed;
    left: 10rem;
  }
</style>
