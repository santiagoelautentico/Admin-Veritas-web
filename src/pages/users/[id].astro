---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";

const { id } = Astro.params;
const token = Astro.cookies.get("access_token")?.value;

if (!token) {
  return Astro.redirect("/");
}

let newsUser = [];
try {
  const response = await fetch(`http://localhost:1234/news/profileNews/${id}`, {
    method: "GET",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
      Cookie: `access_token=${token}`,
    },
  });

  console.log("Response status:", response.status);

  if (!response.ok) {
    const errorText = await response.text();
    console.error("Backend error:", errorText);
  } else {
    const data = await response.json();
    newsUser = data.news || [];
    console.log("News detail:", newsUser);
  }
} catch (error) {
  console.error("Error:", error);
}

const response = await fetch(`http://localhost:1234/users/${id}`, {
  headers: {
    Authorization: `Bearer ${token}`,
    "Content-Type": "application/json",
  },
});

const userData = await response.json();
const user = userData.user;

console.log("User detail:", user);

const countries = {
  1: "Uruguay",
  2: "USA",
  3: "Argentina",
  4: "Brazil",
  5: "Puerto Rico",
};
---

<Layout title={"Profile " + id}>
  <section class="container-profile">
    <article class="article-userData">
      <button class="delete" id="deleteBtn">Delete</button>
      {
        user.picture ? (
          <img src={user.picture} alt={user.username} class="user-picture" />
        ) : (
          <h2 class="icon-profile">{user.username.charAt(0).toUpperCase()}</h2>
        )
      }
      <div class="container-userData-data">
        <div>
          <h1 class="username-title">
            {user.username}
            <span
              >{
                user.role === 'creator'
                  ? `- ${user.type_of_journalist}`
                  : "- Regular user"
              }</span
            >
          </h1>
          <p class="user-email">{newsUser[0]?.email}</p>
        </div>
        <div class="user-stats">
          <p>
            <span class="user-stats-label">Name:</span>
            {user.name_user}
            {user.lastname}
          </p>
          <p><span class="user-stats-label">Email:</span> {user.email}</p>
          <p>
            <span class="user-stats-label">Country:</span>
            {countries[user.id_country as keyof typeof countries] || "Unknown"}
          </p>
          {
            user.role === "creator" || user.role === "admin" ? (
              <p>
                <span class="user-stats-label">Company:</span> {user.company}
              </p>
            ) : (
              ""
            )
          }
          {
            user.role === "creator" || user.role === "admin" ? (
              <p>
                <span class="user-stats-label">Occupation:</span>{" "}
                {user.ocupation}
              </p>
            ) : (
              ""
            )
          }
          {
            user.role === "creator" || user.role === "admin" ? (
              <p>
                <span class="user-stats-label">Identification:</span>{" "}
                {user.identification}
              </p>
            ) : (
              ""
            )
          }
        </div>
      </div>
    </article>
    {
      user.role === "creator" || user.role === "admin" ? (
        <section class="section-news">
          <h1>News:</h1>
          {newsUser.length != 0 ? (
            <section class="container-news">
              {newsUser.map((news) => (
                <article
                  class="news-card"
                  onclick={`window.location.href='/news/${news.id_news}'`}
                >
                  <img
                    src={news.picture_url}
                    alt={news.title}
                    class="news-image"
                  />
                  <h2>{news.title}</h2>
                  <p>{news.subtitle}</p>
                </article>
              ))}
            </section>
          ) : (
            <p>This user has not published news yet.</p>
          )}
        </section>
      ) : (
        ""
      )
    }
  </section>
</Layout>

<script is:inline define:vars={{ id, token }}>
  console.log("Token:", token);

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this news?")) {
        return;
      }

      try {
        const response = await fetch(`http://localhost:1234/users/${id}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          credentials: "include",
        });

        if (response.ok) {
          alert("News deleted successfully");
          window.location.href = "/dashboard";
        } else {
          const errorText = await response.text();
          console.log("Backend error:", errorText);
          alert(`Failed to delete news: ${errorText}`);
        }
      } catch (error) {
        console.error("Error deleting news:", error);
        alert("An error occurred while deleting the news");
      }
    });
  });
</script>

<style>
  .container-profile {
    width: 900px;
    margin: 2rem auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }
  .user-picture {
    width: 8em;
    height: 8em;
    object-fit: cover;
    aspect-ratio: 1/1;
    border-radius: 50%;
    object-fit: cover;
  }
  .article-userData {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding-inline: 50px;
    background-color: #333a3fab;
    border-radius: 28px;
    padding-block: 1em;
    position: relative;
  }
  .container-userData-data h1 {
    align-items: center;
  }
  .container-userData-data h1 > span {
    font-size: 1rem;
    font-weight: 400;
    opacity: 0.8;
  }
  .user-stats {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    padding: 0;
  }
  .user-stats-label {
    font-weight: 400;
    font-size: 0.8rem;
    opacity: 0.7;
  }
  .user-stats p {
    display: flex;
    gap: 0.25rem;
    padding: 0;
    align-items: center;
    margin: 0;
  }
  .username-title {
    margin: 0;
    padding: 0;
  }
  .section-news {
    background-color: #333a3fab;
    padding-inline: 50px;
    padding-block: 0.5em;
    border-radius: 28px;
    padding-bottom: 50px;
  }
  .news-card {
    width: 45%;
    padding: 1em;
    background-color: #333a3f;
    border-radius: 30px;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    cursor: pointer;
    transition: 300ms ease-in;
  }
  .news-card h2 {
    margin: 0;
    padding: 0;
  }
  .news-card p {
    margin: 0;
    padding: 0;
    font-size: 1rem;
    opacity: 0.8;
  }
  .news-image {
    width: 100%;
    height: 30vh;
    border-radius: 28px;
    margin-bottom: 1rem;
    object-fit: cover;
    aspect-ratio: 16/9;
    padding: 0;
    margin: 0;
  }
  .news-card:hover {
    background-color: #444c51;
    box-shadow:
      rgba(50, 50, 93, 0.25) 0px 30px 60px -12px inset,
      rgba(0, 0, 0, 0.3) 0px 18px 36px -18px inset;
  }
  .news-card:hover .news-image {
    box-shadow:
      rgba(0, 0, 0, 0.2) 0px 12px 28px 0px,
      rgba(0, 0, 0, 0.1) 0px 2px 4px 0px,
      rgba(255, 255, 255, 0.05) 0px 0px 0px 1px inset;
  }
  .container-news {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
  }
  .icon-profile {
    padding-inline: 1.7em;
    padding-block: 1.4em;
    background-color: #0f4c81;
    border-radius: 50%;
  }
  .delete {
    background-color: #ff4d4d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 1rem;
    position: absolute;
    right: 2rem;
    top: 1em;
    transition: background-color 300ms ease;
  }
  .delete:hover {
    background-color: #d33232;
  }
</style>
