---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { API_NETWORK } from "../../constants";
const { id } = Astro.params;
const token = Astro.cookies.get("authToken")?.value;

if (!token) {
  return Astro.redirect("/");
}

let newsUser = [];
let user = null;
try {
  const response = await fetch(`${API_NETWORK}news/profileNews/${id}`, {
    method: "GET",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
      Cookie: `access_token=${token}`,
    },
  });
  if (response.ok) {
    const data = await response.json();
    newsUser = data.news || [];
  } else {
    const errorText = await response.text();
    console.error("‚ùå News error:", errorText);
  }
} catch (error) {
  console.error("üí• News fetch error:", error);
}
try {
  const url = `${API_NETWORK}users/${id}`;
  const response = await fetch(url, {
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
    },
  });
  const rawText = await response.text();
  try {
    const userData = JSON.parse(rawText);
    user = userData.user;
    console.log("‚úÖ User loaded:", user);
  } catch (parseError) {
    console.error("‚ùå Failed to parse JSON. Response was:", rawText);
    throw parseError;
  }
} catch (error) {
  console.error("üí• User fetch error:", error);
  return Astro.redirect("/dashboard");
}

const countries = {
  1: "Uruguay",
  2: "Argentina",
  3: "Spain",
  4: "United States",
  5: "Puerto Rico",
};
    // { id: 1, name: "Uruguay" },
    // { id: 2, name: "Argentina" },
    // { id: 3, name: "Spain" },
    // { id: 4, name: "United States" },
    // { id: 5, name: "Puerto Rico" },
---

<Layout title={"Profile " + id}>
  <section class="container-profile">
    <article class="article-userData">
      <button class="delete" id="deleteBtn">Delete</button>
      {
        user.picture ? (
          <img src={user.picture} alt={user.username} class="user-picture" />
        ) : (
          <h2 class="icon-profile">{user.username.charAt(0).toUpperCase()}</h2>
        )
      }
      <div class="container-userData-data">
        <div>
          <h1 class="username-title">
            {user.username}
            <span
              >{
                user.role === "creator"
                  ? `- ${user.type_of_journalist}`
                  : "- Regular user"
              }</span
            >
          </h1>
          <p class="user-email">{newsUser[0]?.email}</p>
        </div>
        <div class="user-stats">
          <p>
            <span class="user-stats-label">Name:</span>
            {user.name_user}
            {user.lastname}
          </p>
          <p><span class="user-stats-label">Email:</span> {user.email}</p>
          <p>
            <span class="user-stats-label">Country:</span>
            {countries[user.id_country as keyof typeof countries] || "Unknown"}
          </p>
          {
            user.role === "creator" || user.role === "admin" ? (
              <p>
                <span class="user-stats-label">Company:</span> {user.company}
              </p>
            ) : (
              ""
            )
          }
          {
            user.role === "creator" || user.role === "admin" ? (
              <p>
                <span class="user-stats-label">Occupation:</span>{" "}
                {user.ocupation}
              </p>
            ) : (
              ""
            )
          }
          {
            user.role === "creator" || user.role === "admin" ? (
              <p>
                <span class="user-stats-label">Identification:</span>{" "}
                {user.identification}
              </p>
            ) : (
              ""
            )
          }
        </div>
      </div>
    </article>
    {
      user.role === "creator" || user.role === "admin" ? (
        <section class="section-news">
          {user.request === null ? <h1>News:</h1> : ""}
          {newsUser.length != 0 ? (
            <section class="container-news">
              {newsUser.map((news) => (
                <article
                  class="news-card"
                  onclick={`window.location.href='/news/${news.id_news}'`}
                >
                  <img
                    src={news.picture_url}
                    alt={news.title}
                    class="news-image"
                  />
                  <h2>{news.title}</h2>
                  <p>{news.subtitle}</p>
                </article>
              ))}
            </section>
          ) : user.status_account === 1 ? (
            <section class="container-news">
              <h2>The user dont have post yet</h2>
            </section>
          ) : (
            <article class="container-request">
              <h2 class="title-request">Request:</h2>
              <p class="rquestText">{user.request}</p>
              <button class="primary-btn" id="activateBtn">
                Confirm the request
              </button>
            </article>
          )}
        </section>
      ) : (
        ""
      )
    }
  </section>
</Layout>

<script is:inline define:vars={{ id, token, apiUrl: API_NETWORK }}>
  console.log("Token:", token);

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this news?")) {
        return;
      }

      try {
        const response = await fetch(`${apiUrl}users/${id}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          credentials: "include",
        });

        if (response.ok) {
          alert("News deleted successfully"); 
          window.location.href = "/dashboard";
        } else {
          const errorText = await response.text();
          console.log("Backend error:", errorText);
          alert(`Failed to delete news: ${errorText}`);
        }
      } catch (error) {
        console.error("Error deleting news:", error);
        alert("An error occurred while deleting the news");
      }
    });
  });
  const activateBtn = document.getElementById("activateBtn");
  if (activateBtn) {
    activateBtn.addEventListener("click", async () => {
      if (!confirm("Are you sure you want to activate this account?")) {
        return;
      }
      try {
        const response = await fetch(`${apiUrl}users/${id}/activate`, {
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
            Cookie: `access_token=${token}`,
          },
          credentials: "include",
        });
        if (response.ok) {
          alert("Account activated successfully");
          window.location.reload(); 
        } else {
          const errorText = await response.text();
          alert(`Failed to activate account: ${errorText}`);
        }
      } catch (error) {
        console.error("Error activating account:", error);
        alert("An error occurred while activating the account");
      }
    });
  }
</script>

<style>
  .container-profile {
    width: 900px;
    margin: 2rem auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    position: relative;
  }
  .user-picture {
    width: 8em;
    height: 8em;
    object-fit: cover;
    aspect-ratio: 1/1;
    border-radius: 50%;
    object-fit: cover;
  }
  .article-userData {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding-inline: 50px;
    background-color: #333a3fab;
    border-radius: 28px;
    padding-block: 1em;
    position: relative;
  }
  .container-request {
  }
  ,
  .container-userData-data h1 {
    align-items: center;
  }
  .container-userData-data h1 > span {
    font-size: 1rem;
    font-weight: 400;
    opacity: 0.8;
  }
  .user-stats {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    padding: 0;
  }
  .user-stats-label {
    font-weight: 400;
    font-size: 0.8rem;
    opacity: 0.7;
  }
  .user-stats p {
    display: flex;
    gap: 0.25rem;
    padding: 0;
    align-items: center;
    margin: 0;
  }
  .username-title {
    margin: 0;
    padding: 0;
  }
  .section-news {
    background-color: #333a3fab;
    padding-inline: 50px;
    padding-block: 0.5em;
    border-radius: 28px;
    padding-bottom: 50px;
  }
  .news-card {
    width: 45%;
    padding: 1em;
    background-color: #333a3f;
    border-radius: 30px;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    cursor: pointer;
    transition: 300ms ease-in;
    margin-bottom: 1rem;
  }
  .news-card h2 {
    margin: 0;
    padding: 0;
  }
  .news-card p {
    margin: 0;
    padding: 0;
    font-size: 1rem;
    opacity: 0.8;
  }
  .news-image {
    width: 100%;
    height: 30vh;
    border-radius: 28px;
    margin-bottom: 1rem;
    object-fit: cover;
    aspect-ratio: 16/9;
    padding: 0;
    margin: 0;
  }
  .news-card:hover {
    background-color: #444c51;
    box-shadow:
      rgba(50, 50, 93, 0.25) 0px 30px 60px -12px inset,
      rgba(0, 0, 0, 0.3) 0px 18px 36px -18px inset;
  }
  .news-card:hover .news-image {
    box-shadow:
      rgba(0, 0, 0, 0.2) 0px 12px 28px 0px,
      rgba(0, 0, 0, 0.1) 0px 2px 4px 0px,
      rgba(255, 255, 255, 0.05) 0px 0px 0px 1px inset;
  }
  .container-news {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
  }
  .icon-profile {
    padding-inline: 1.7em;
    padding-block: 1.4em;
    background-color: #0f4c81;
    border-radius: 50%;
  }
  .delete {
    background-color: #ff4d4d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 1rem;
    position: absolute;
    right: 2rem;
    top: 1em;
    transition: background-color 300ms ease;
  }
  .delete:hover {
    background-color: #d33232;
  }
  .primary-btn {
    background-color: #ffc857;
    padding: 1em;
    border-radius: 16px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    transition: scale 300ms ease;
    transition: box-shadow 300ms ease;
    transition: background-color 700ms ease;
    width: max-content;
  }
  .primary-btn:hover {
    box-shadow:
      rgba(50, 50, 93, 0.25) 0px 30px 60px -12px inset,
      rgba(0, 0, 0, 0.3) 0px 18px 36px -18px inset;
    scale: 1.05;
    background-color: #34c759;
  }
  .rquestText {
    padding: 1em;
    background-color: #121212;
    border-radius: 20px;
    margin: 0;
  }
  .title-request {
    padding: 1em 0 0 0;
    margin: 0;
  }
  .container-request {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>
